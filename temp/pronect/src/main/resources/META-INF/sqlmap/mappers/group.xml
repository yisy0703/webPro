<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.google.pronect.dao.GroupDao">
	<resultMap type="Group" id="GroupResult">
		<result property="gid" column="gid"/>
		<result property="gcharacter" column="gcharacter"/>
		<result property="mid" column="mid"/>
		<result property="gtitle" column="gtitle"/>
		<result property="gcontent" column="gcontent"/>
		<result property="gpeople" column="gpeople"/>
		<result property="glanguage1" column="glanguage1"/>
		<result property="glanguage2" column="glanguage2"/>
		<result property="glanguage3" column="glanguage3"/>
		<result property="gdev" column="gdev"/>
		<result property="gdesign" column="gdesign"/>
		<result property="gpm" column="gpm"/>
		<result property="grdate" column="grdate"/>
		<result property="gsdate" column="gsdate"/>
		<result property="gfdate" column="gfdate"/>
		<result property="ghit" column="ghit"/>
		<result property="gloc" column="gloc"/>
		<result property="gcomplete" column="gcomplete"/>
		<result property="startRow" column="startRow"/>
		<result property="endRow" column="endRow"/>
		<result property="mimage" column="mimage"/>
		<result property="gsid" column="gsid"/>
		<result property="mnickname" column="mnickname"/>
	</resultMap>
	<select id="groupList" parameterType="Group" resultMap="GroupResult">
		SELECT A.*, COALESCE(C.COMMENT_COUNT, 0) AS COMMENT_COUNT
		FROM 
		    (SELECT ROWNUM RN, G.GID, G.GCHARACTER, M.MID, M.MIMAGE, M.MNICKNAME, G.GTITLE, G.GCONTENT, G.GPEOPLE, G.GCURPEOPLE,
		           G.GLANGUAGE1, G.GLANGUAGE2, G.GLANGUAGE3, G.GDEV, G.GDESIGN, G.GPM, G.GRDATE, G.GSDATE, G.GFDATE, G.GHIT, G.GLOC, G.GCOMPLETE 
		    FROM MYGROUP G
		    INNER JOIN MEMBER M ON G.MID = M.MID 
		    WHERE G.GCOMPLETE = 'N' 
		    ORDER BY G.GID DESC) A
		LEFT JOIN 
		    (SELECT GID, COUNT(*) AS COMMENT_COUNT
		    FROM GCOMMENT
		    GROUP BY GID) C
		ON A.GID = C.GID
		WHERE A.RN BETWEEN #{startRow} AND #{endRow}
	</select>
	<select id="groupTotCnt" resultType="int">
		SELECT COUNT(*) FROM MYGROUP WHERE GCOMPLETE = 'N'
	</select>
	<select id="studyList" parameterType="Group" resultMap="GroupResult">
		SELECT A.*, COALESCE(C.COMMENT_COUNT, 0) AS COMMENT_COUNT
		FROM 
		    (SELECT ROWNUM RN, G.GID, G.GCHARACTER, M.MID, M.MIMAGE, M.MNICKNAME, G.GTITLE, G.GCONTENT, G.GPEOPLE, G.GCURPEOPLE,
		           G.GLANGUAGE1, G.GLANGUAGE2, G.GLANGUAGE3, G.GDEV, G.GDESIGN, G.GPM, G.GRDATE, G.GSDATE, G.GFDATE, G.GHIT, G.GLOC, G.GCOMPLETE 
		    FROM MYGROUP G
		    INNER JOIN MEMBER M ON G.MID = M.MID 
		    WHERE G.GCOMPLETE = 'N' and GCHARACTER='S'
		    ORDER BY G.GID DESC) A
		LEFT JOIN 
		    (SELECT GID, COUNT(*) AS COMMENT_COUNT
		    FROM GCOMMENT
		    GROUP BY GID) C
		ON A.GID = C.GID
		WHERE A.RN BETWEEN #{startRow} AND #{endRow}
	</select>
	<select id="studyTotCnt" resultType="int">
		SELECT COUNT(*) FROM MYGROUP WHERE GCOMPLETE = 'N' AND GCHARACTER='S'
	</select>
	<select id="projectList" parameterType="Group" resultMap="GroupResult">
		SELECT A.*, COALESCE(C.COMMENT_COUNT, 0) AS COMMENT_COUNT
		FROM 
		    (SELECT ROWNUM RN, G.GID, G.GCHARACTER, M.MID, M.MIMAGE, M.MNICKNAME, G.GTITLE, G.GCONTENT, G.GPEOPLE, G.GCURPEOPLE,
		           G.GLANGUAGE1, G.GLANGUAGE2, G.GLANGUAGE3, G.GDEV, G.GDESIGN, G.GPM, G.GRDATE, G.GSDATE, G.GFDATE, G.GHIT, G.GLOC, G.GCOMPLETE 
		    FROM MYGROUP G
		    INNER JOIN MEMBER M ON G.MID = M.MID 
		    WHERE G.GCOMPLETE = 'N' AND GCHARACTER = 'P'
		    ORDER BY G.GID DESC) A
		LEFT JOIN 
		    (SELECT GID, COUNT(*) AS COMMENT_COUNT
		    FROM GCOMMENT
		    GROUP BY GID) C
		ON A.GID = C.GID
		WHERE A.RN BETWEEN #{startRow} AND #{endRow}
	</select>
	<select id="projectTotCnt" resultType="int">
		SELECT COUNT(*) FROM MYGROUP WHERE GCOMPLETE = 'N' AND GCHARACTER='P'
	</select>
	<select id="groupLeader" parameterType="String" resultType="int">
		SELECT COUNT(*) FROM MYGROUP WHERE MID = #{mid} AND GCOMPLETE='N'
	</select>
	<insert id="registerGroup" parameterType="Group">
		INSERT INTO MYGROUP (GID, GCHARACTER, MID, GTITLE, GCONTENT, GPEOPLE, GCURPEOPLE, 
                    GLANGUAGE1, GLANGUAGE2, GLANGUAGE3, GDEV, GDESIGN, GPM, GSDATE, GFDATE, GLOC)
            VALUES(MYGROUP_SEQ.NEXTVAL, #{gcharacter}, #{mid},#{gtitle},#{gcontent}, #{gpeople}, 1,
                    #{glanguage1},#{glanguage2},#{glanguage3}, #{gdev}, #{gdesign}, #{gpm}, #{gsdate}, #{gfdate}, #{gloc})
 	  
	</insert>
	<select id="getRegisteredGid" parameterType="String" resultType="int">
		SELECT GID FROM MYGROUP WHERE MID = #{mid} AND GCOMPLETE = 'N'
	</select>
	<insert id="insertHistory" parameterType="Group">
		INSERT INTO GSTATUS (GSID, MID, GID, GSSTATUS)
            VALUES (GSTATUS_SEQ.NEXTVAL, #{mid}, #{gid}, 2)
	  <selectKey resultType="Integer" keyProperty="gsid" order="AFTER">
	  	SELECT MAX(GSID) FROM GSTATUS
	  </selectKey>
	</insert>
	<update id="groupHitUp" parameterType="int">
		UPDATE MYGROUP SET GHIT=GHIT+1 WHERE GID = #{gid}
	</update>
	<select id="getGroupDetail" parameterType="int" resultType="Group">
		SELECT M.MID MID, MIMAGE, MNICKNAME, GCHARACTER, GRDATE, GID ,GTITLE, GCONTENT, GPEOPLE, GCURPEOPLE, GLANGUAGE1, GLANGUAGE2, GLANGUAGE3, GDEV, GDESIGN, GPM, TO_CHAR(GSDATE, 'YYYY-MM-DD') GSDATE, TO_CHAR(GFDATE, 'YYYY-MM-DD') GFDATE, GLOC
			FROM MYGROUP G,MEMBER M WHERE G.MID=M.MID AND GID=#{gid}
	</select>
	<update id="modifyGroup" parameterType="Group">
		UPDATE MYGROUP SET GTITLE = #{gtitle},
                GCONTENT = #{gcontent},
                GPEOPLE = #{gpeople},
                GLANGUAGE1 = #{glanguage1},
                GLANGUAGE2 = #{glanguage2},
                GLANGUAGE3 = #{glanguage3},
   <if test="gcharacter=='P'">
                GDEV = #{gdev}, 
                GDESIGN = #{gdesign}, 
                GPM = #{gpm},
   </if>
                GSDATE = TO_DATE(TO_CHAR(#{gsdate}), 'YYYY-MM-DD'),
                GFDATE = TO_DATE(TO_CHAR(#{gfdate}), 'YYYY-MM-DD'),
                GLOC = #{gloc}
        WHERE GID = #{gid}
	</update>
	<update id="deleteHistory" parameterType="int">
		UPDATE GSTATUS SET GSSTATUS = 4 WHERE GID = #{gid}
	</update>
	<update id="deleteGroup" parameterType="int">
		UPDATE MYGROUP SET GCOMPLETE = 'D' WHERE GID = #{gid}
	</update>
	<select id="joinCheck" parameterType="Group" resultType="int">
		SELECT COUNT(*) FROM GSTATUS WHERE MID = #{mid} AND GID = #{gid} AND GSSTATUS = 1
	</select>
	<insert id="joinGroup" parameterType="Group">
		INSERT INTO GSTATUS (GSID, MID, GID, GSSTATUS)
            VALUES (GSTATUS_SEQ.NEXTVAL, #{mid}, #{gid},1)
 	  <selectKey resultType="Integer" keyProperty="gsid" order="AFTER">
  		SELECT MAX(GSID) FROM GSTATUS
  	</selectKey>
	</insert>
	<delete id="unJoinGroup" parameterType="Group">
		DELETE FROM GSTATUS WHERE MID = #{mid} AND GID = #{gid} AND GSSTATUS = 1
	</delete>
	<select id="joinList" parameterType="int" resultMap="GroupResult">
		SELECT MIMAGE, M.MID MID, GID, GSID ,GSSTATUS,MNICKNAME FROM MEMBER M, GSTATUS G WHERE M.MID = G.MID AND G.GID = #{gid} AND GSSTATUS= 1
	</select>
	<update id="acceptGroup" parameterType="Group">
		UPDATE GSTATUS SET GSSTATUS = 2 WHERE MID = #{mid} AND GID = #{gid} AND GSSTATUS = 1
	</update>
	<update id="memberPlus" parameterType="int">
		UPDATE MYGROUP SET GCURPEOPLE = GCURPEOPLE+1 WHERE GID = #{gid}
	</update>
	<select id="memberFullCheck" parameterType="int" resultType="Group">
		SELECT GPEOPLE, GCURPEOPLE FROM MYGROUP WHERE GID = #{gid}
	</select>
	<update id="peopleFull" parameterType="int">
		UPDATE MYGROUP SET GCOMPLETE = 'F' WHERE GID = #{gid}
	</update>
	<select id="groupMember" parameterType="int" resultMap="GroupResult">
		SELECT GSID, M.MID MID, MIMAGE, MNICKNAME, GID FROM MEMBER M, GSTATUS G WHERE M.MID = G.MID AND GID = #{gid} AND GSSTATUS = 2
	</select>
	<update id="memberOut" parameterType="Group">
		UPDATE GSTATUS SET GSSTATUS = 0 WHERE MID = #{mid} AND GID = #{gid} AND GSSTATUS = 2
	</update>
	<update id="memberMinus" parameterType="int">
		UPDATE MYGROUP SET GCURPEOPLE = GCURPEOPLE-1 WHERE GID = #{gid}
	</update>
	<update id="peopleUnFull" parameterType="int">
		UPDATE MYGROUP SET GCOMPLETE = 'N' WHERE GID = #{gid}
	</update>
	<update id="completeGroup" parameterType="int">
		UPDATE GSTATUS SET GSSTATUS = 3 WHERE GID = #{gid} AND GSSTATUS = 2
	</update>
	<delete id="joinDelete" parameterType="int">
		DELETE FROM GSTATUS WHERE GID = #{gid} AND GSSTATUS = 1
	</delete>
	<select id="getCommentCnt" resultType="int">
		SELECT GID, COUNT(*) AS COMMENT_COUNT FROM GCOMMENT GROUP BY GID
	</select>
	<select id="hitGroup" resultMap="GroupResult">
		SELECT ROWNUM, GTITLE, GID FROM (SELECT * FROM MYGROUP WHERE GCOMPLETE='N' ORDER BY GHIT DESC) A WHERE ROWNUM BETWEEN 1 AND 10
	</select>
	<update id="giveUp">
	
	</update>
</mapper>