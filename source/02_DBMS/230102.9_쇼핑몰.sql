-- [IX] 쇼핑몰 DB의 예
DROP TABLE CART;
DROP TABLE ORDER_DETAIL;
DROP TABLE ORDERS;
DROP TABLE MEMBER;
DROP TABLE PRODUCT; -- 테이블 삭제가 안 되면 참조되는 테이블이 있는 경우
                    -- 무시하고 삭제하고자 하면 CASCADE CONSTRAINTS 추가
    -- 식별관계 : 부모테이블의 주키가 자식 테이블의 주키
    -- 비식별관계 : 부모테이블의 주키가 자식테이블의 일반속성
CREATE TABLE MEMBER(
    mID VARCHAR2(20) PRIMARY KEY,
    mNAME VARCHAR2(50) NOT NULL,
    mADDR VARCHAR2(255),
    mTEL VARCHAR2(30),    
    mMAIL VARCHAR2(40) NOT NULL
);
CREATE TABLE PRODUCT(
    pCODE VARCHAR2(5) PRIMARY KEY,
    pNAME VARCHAR2(50) NOT NULL,
    PRICE NUMBER(6) NOT NULL CHECK(PRICE>0),
    pSTOCK NUMBER(3) NOT NULL CHECK(pSTOCK>=0)
);
DROP SEQUENCE CART_SEQ; 
CREATE SEQUENCE CART_SEQ MAXVALUE 999999999 NOCACHE;
CREATE TABLE CART(
    cNO NUMBER(9) PRIMARY KEY,
    mID VARCHAR2(20) REFERENCES MEMBER(mID) NOT NULL,
    pCODE VARCHAR2(5) REFERENCES PRODUCT(pCODE) NOT NULL,
    QTY NUMBER(3) CHECK(QTY>0) NOT NULL,
    COST NUMBER(9) -- 밑에 추가해도 됨. FOREIGN KEY(mID) REFERENCES MEMBER(mID)
);
DROP SEQUENCE ORDERS_SEQ;
CREATE SEQUENCE ORDERS_SEQ MAXVALUE 999 NOCACHE;
CREATE TABLE ORDERS(
    oNO NUMBER(9) PRIMARY KEY,
    mID VARCHAR2(10) REFERENCES MEMBER(mID) NOT NULL,
    oNAME VARCHAR2(50) NOT NULL,
    oADDR VARCHAR2(255) NOT NULL,
    oTEL VARCHAR2(30) NOT NULL,
    oDATE DATE DEFAULT SYSDATE
);
DROP SEQUENCE ORDER_DETAIL_SEQ;
CREATE SEQUENCE ORDER_DETAIL_SEQ MAXVALUE 999999999 NOCYCLE NOCACHE;
CREATE TABLE ORDER_DETAIL(
    odNO  NUMBER(9) PRIMARY KEY,
    oNO   NUMBER(9) REFERENCES ORDERS(oNO) NOT NULL,
    pCODE VARCHAR2(5) REFERENCES PRODUCT(pCODE) NOT NULL,
    QTY   NUMBER(3) NOT NULL CHECK(QTY>0),
    COST  NUMBER(9)
);
SELECT * FROM MEMBER;
SELECT * FROM PRODUCT;
SELECT * FROM CART;
SELECT * FROM ORDERS;
SELECT * FROM ORDER_DETAIL;
INSERT INTO MEMBER VALUES ('abc','홍길동','서울 서대문구','010-9999-9999','hong@hong.com');
INSERT INTO MEMBER VALUES ('def','김김동','경기도 수원시','010-8888-8888','kim@kim.com');
SELECT * FROM MEMBER;
INSERT INTO PRODUCT VALUES ('A1', '맥주', 3000, 200);
INSERT INTO PRODUCT VALUES ('A2', '마스크', 200, 500);
INSERT INTO PRODUCT VALUES ('B1', '땅콩', 3000, 200);
INSERT INTO PRODUCT VALUES ('B2', '오징어', 5000, 200);
INSERT INTO PRODUCT VALUES ('C1', '소독약', 7000, 200);
SELECT * FROM PRODUCT;

-- 주문번호 가져오기 ('230102' || ' 001' => '230102001')
SELECT TO_CHAR(SYSDATE, 'RRMMDD')||TRIM(TO_CHAR(ORDERS_SEQ.NEXTVAL, '000')) oNO FROM DUAL;
SELECT TO_CHAR(SYSDATE, 'RRMMDD')||SUBSTR(TO_CHAR(ORDERS_SEQ.NEXTVAL, '000'),2,3) FROM DUAL;
SELECT concat(TO_CHAR(SYSDATE, 'RRMMDD'),TO_CHAR(ORDERS_SEQ.NEXTVAL, '000')) oNO FROM DUAL;
DROP SEQUENCE ORDERS_SEQ;
CREATE SEQUENCE ORDERS_SEQ MAXVALUE 999 NOCACHE;

-- ▒▒▒▒▒ 첫번째 홍길동님 주문서 (23.1.10) ▒▒▒▒▒
INSERT INTO CART VALUES (CART_SEQ.NEXTVAL, 'abc', 'A1', 3, (select price from product where pcode='A1')*3);
INSERT INTO CART VALUES (CART_SEQ.NEXTVAL, 'abc', 'B1', 1, (select price from product where pcode='B1')*1);
SELECT 
    -- ORDER_DETAIL_SEQ.NEXTVAL odNO, 
        TO_CHAR(SYSDATE, 'RRMMDD')||TRIM(TO_CHAR(ORDERS_SEQ.CURRVAL, '000')) ono, 
        pcode, qty, cost 
    FROM CART WHERE MID='abc'; -- cart 확인
-- ORDERS(주문)테이블
INSERT INTO ORDERS (ONO, MID, ONAME, OADDR, OTEL)
    VALUES (TO_CHAR(SYSDATE, 'RRMMDD')||TRIM(TO_CHAR(ORDERS_SEQ.NEXTVAL, '000')),
            'abc', '홍길동', '서울시 서대문구', '010-9999-9999');
-- ORDER_DETAIL(주문상세) 테이블
INSERT INTO ORDER_DETAIL (odNO, oNO, pCODE, QTY, COST)
    SELECT ORDER_DETAIL_SEQ.NEXTVAL, 
        TO_CHAR(SYSDATE, 'RRMMDD')||TRIM(TO_CHAR(ORDERS_SEQ.CURRVAL, '000')) ono, 
        pcode, qty, cost 
    FROM CART  WHERE MID='abc'; -- 서브쿼리 이용하여 장바구니의 모든 상품을 주문할 경우
-- 아래는 서브쿼리를 이용하지 않고 일부 상품만 구매할 경우 따로 따로 입력
-- A1, 맥주, 3000, 3개
INSERT INTO ORDER_DETAIL (odNO, oNO, pCODE, QTY, COST)
    VALUES (ORDER_DETAIL_SEQ.NEXTVAL,
        TO_CHAR(SYSDATE, 'RRMMDD')||TRIM(TO_CHAR(ORDERS_SEQ.CURRVAL, '000')),
        'A1',
        3,
        (SELECT PRICE FROM PRODUCT WHERE pCODE='A1')*3);
UPDATE PRODUCT SET pSTOCK = pSTOCK-3 WHERE pCODE='A1'; -- 재고 수량 수정
-- B1, 땅콩, 3000, 1개
INSERT INTO ORDER_DETAIL (odNO, oNO, pCODE, QTY, COST)
    VALUES
    (ORDER_DETAIL_SEQ.NEXTVAL, 
    TO_CHAR(SYSDATE, 'RRMMDD')||TRIM(TO_CHAR(ORDERS_SEQ.CURRVAL, '000')), 
    'B1',
    1, 
    (SELECT PRICE FROM PRODUCT WHERE pCODE='B1')*1);
UPDATE PRODUCT SET pSTOCK = pSTOCK-1 WHERE pCODE='B1';-- 재고 수량 수정
DELETE FROM CART WHERE MID='abc';-- 장바구니 비우기

-- 주문서에 필요한 데이터 출력
--현재 주문번호만 SELECT절에 현재 시퀀스값을 이용하여 가져올 수 있으나 시퀀스.CURRVAL은 WHERE절에서 사용할 수 없음
SELECT TO_CHAR(SYSDATE, 'RRMMDD')||TRIM(TO_CHAR(ORDERS_SEQ.CURRVAL, '000')) FROM DUAL; 

SELECT * FROM ORDERS WHERE ONO=230102001;

SELECT O.PCODE, PNAME, PRICE, QTY, COST
    FROM ORDER_DETAIL O, PRODUCT P
    WHERE O.PCODE=P.PCODE AND
        ONO=230102001;

-- ▒▒▒▒▒ 김김동님 주문서 (23.1.10) ▒▒▒▒▒
INSERT INTO CART VALUES (CART_SEQ.NEXTVAL, 'def', 'A2', 20, (select price from product where pcode='A2')*20);
INSERT INTO CART VALUES (CART_SEQ.NEXTVAL, 'def', 'B2', 2, (select price from product where pcode='B2')*2);
INSERT INTO CART VALUES (CART_SEQ.NEXTVAL, 'def', 'C1', 1, (select price from product where pcode='C1')*1);
SELECT 
    -- ORDER_DETAIL_SEQ.NEXTVAL odNO, 
        TO_CHAR(SYSDATE, 'RRMMDD')||TRIM(TO_CHAR(ORDERS_SEQ.CURRVAL, '000')) ono, 
        pcode, qty, cost 
    FROM CART WHERE MID='def'; -- cart 확인
-- ORDERS(주문)테이블
INSERT INTO ORDERS
    VALUES (TO_CHAR(SYSDATE, 'RRMMDD')||TRIM(TO_CHAR(ORDERS_SEQ.NEXTVAL, '000')),
            'def', '김김동', '경기도 수원시', '010-8888-8888', SYSDATE);
-- ORDER_DETAIL(주문상세) 테이블
INSERT INTO ORDER_DETAIL (odNO, oNO, pCODE, QTY, COST)
    SELECT ORDER_DETAIL_SEQ.NEXTVAL, 
        TO_CHAR(SYSDATE, 'RRMMDD')||TRIM(TO_CHAR(ORDERS_SEQ.CURRVAL, '000')) ono, 
        pcode, qty, cost 
    FROM CART WHERE MID='def'; -- 서브쿼리 이용하여 장바구니의 모든 상품을 주문할 경우
-- 아래는 서브쿼리를 이용하지 않고 일부 상품만 구매할 경우 따로 따로 입력
-- A2, 마스크, 200, 20개
INSERT INTO ORDER_DETAIL (odNO, oNO, pCODE, QTY, COST)
    VALUES (ORDER_DETAIL_SEQ.NEXTVAL,
        TO_CHAR(SYSDATE, 'RRMMDD')||TRIM(TO_CHAR(ORDERS_SEQ.CURRVAL, '000')),
        'A2',
        20,
        (SELECT PRICE FROM PRODUCT WHERE pCODE='A2')*20);
UPDATE PRODUCT SET pSTOCK = pSTOCK-20 WHERE pCODE='A2'; -- 재고 수량 수정
-- B2, 오징어, 5000, 2개
INSERT INTO ORDER_DETAIL (odNO, oNO, pCODE, QTY, COST)
    VALUES
    (ORDER_DETAIL_SEQ.NEXTVAL, 
    TO_CHAR(SYSDATE, 'RRMMDD')||TRIM(TO_CHAR(ORDERS_SEQ.CURRVAL, '000')), 
    'B2',
    2, 
    (SELECT PRICE FROM PRODUCT WHERE pCODE='B2')*2);
UPDATE PRODUCT SET pSTOCK = pSTOCK-2 WHERE pCODE='B2';-- 재고 수량 수정
-- C1, 소독약, 7000, 1개
INSERT INTO ORDER_DETAIL (odNO, oNO, pCODE, QTY, COST)
    VALUES
    (ORDER_DETAIL_SEQ.NEXTVAL, 
    TO_CHAR(SYSDATE, 'RRMMDD')||TRIM(TO_CHAR(ORDERS_SEQ.CURRVAL, '000')), 
    'C1',
    1, 
    (SELECT PRICE FROM PRODUCT WHERE pCODE='C1')*1);
UPDATE PRODUCT SET pSTOCK = pSTOCK-1 WHERE pCODE='C1';-- 재고 수량 수정
DELETE FROM CART WHERE MID='def'; -- 장바구니 비우기
-- 주문서에 필요한 데이터 출력
--현재 주문번호만 SELECT절에 현재 시퀀스값을 이용하여 가져올 수 있으나 시퀀스.CURRVAL은 WHERE절에서 사용할 수 없음
SELECT TO_CHAR(SYSDATE, 'RRMMDD')||TRIM(TO_CHAR(ORDERS_SEQ.CURRVAL, '000')) FROM DUAL; 

SELECT * FROM ORDERS WHERE ONO=230102002;

SELECT O.PCODE, PNAME, PRICE, QTY, COST
    FROM ORDER_DETAIL O, PRODUCT P
    WHERE O.PCODE=P.PCODE AND
        ONO=230102002;
        
-- ▒▒▒▒▒ 홍길동님 주문서 (23.1.12) ▒▒▒▒▒
-- ORDERS(주문)테이블
INSERT INTO CART VALUES (CART_SEQ.NEXTVAL, 'abc', 'A1', 2, (select price from product where pcode='A1')*2);
INSERT INTO CART VALUES (CART_SEQ.NEXTVAL, 'abc', 'B1', 1, (select price from product where pcode='B1')*1);
INSERT INTO CART VALUES (CART_SEQ.NEXTVAL, 'abc', 'C1', 1, (select price from product where pcode='C1')*1);
SELECT 
    -- ORDER_DETAIL_SEQ.NEXTVAL odNO, 
        TO_CHAR(SYSDATE, 'RRMMDD')||TRIM(TO_CHAR(ORDERS_SEQ.CURRVAL, '000')) ono, 
        pcode, qty, cost 
    FROM CART WHERE MID='abc'; -- 장바구니 확인

INSERT INTO ORDERS (ONO, MID, ONAME, OADDR, OTEL)
    VALUES (TO_CHAR(SYSDATE, 'RRMMDD')||TRIM(TO_CHAR(ORDERS_SEQ.NEXTVAL, '000')),
            'abc', '홍아빠', '제주도 제주시', '010-7777-9999');
-- ORDER_DETAIL(주문상세) 테이블
INSERT INTO ORDER_DETAIL (odNO, oNO, pCODE, QTY, COST)
    SELECT ORDER_DETAIL_SEQ.NEXTVAL, 
        TO_CHAR(SYSDATE, 'RRMMDD')||TRIM(TO_CHAR(ORDERS_SEQ.CURRVAL, '000')) ono, 
        pcode, qty, cost 
    FROM CART WHERE MID='abc'; -- 서브쿼리 이용하여 장바구니의 모든 상품을 주문할 경우
-- 아래는 서브쿼리를 이용하지 않고 일부 상품만 구매할 경우 따로 따로 입력
-- A1, 맥주, 3000, 2개
INSERT INTO ORDER_DETAIL (odNO, oNO, pCODE, QTY, COST)
    VALUES (ORDER_DETAIL_SEQ.NEXTVAL,
        TO_CHAR(SYSDATE, 'RRMMDD')||TRIM(TO_CHAR(ORDERS_SEQ.CURRVAL, '000')),
        'A1',
        2,
        (SELECT PRICE FROM PRODUCT WHERE pCODE='A1')*2);
UPDATE PRODUCT SET pSTOCK = pSTOCK-2 WHERE pCODE='A1'; -- 재고 수량 수정
-- B1, 땅콩, 3000, 1개
INSERT INTO ORDER_DETAIL (odNO, oNO, pCODE, QTY, COST)
    VALUES
    (ORDER_DETAIL_SEQ.NEXTVAL, 
    TO_CHAR(SYSDATE, 'RRMMDD')||TRIM(TO_CHAR(ORDERS_SEQ.CURRVAL, '000')), 
    'B1',
    1, 
    (SELECT PRICE FROM PRODUCT WHERE pCODE='B1')*1);
UPDATE PRODUCT SET pSTOCK = pSTOCK-1 WHERE pCODE='B1';-- 재고 수량 수정
-- C1, 소독약, 7000, 1개
INSERT INTO ORDER_DETAIL (odNO, oNO, pCODE, QTY, COST)
    VALUES
    (ORDER_DETAIL_SEQ.NEXTVAL, 
    TO_CHAR(SYSDATE, 'RRMMDD')||TRIM(TO_CHAR(ORDERS_SEQ.CURRVAL, '000')), 
    'C1',
    1, 
    (SELECT PRICE FROM PRODUCT WHERE pCODE='C1')*1);
UPDATE PRODUCT SET pSTOCK = pSTOCK-1 WHERE pCODE='C1';-- 재고 수량 수정
DELETE FROM CART WHERE MID='abc'; -- 장바구니 비우기

-- 주문서에 필요한 데이터 출력
--현재 주문번호만 SELECT절에 현재 시퀀스값을 이용하여 가져올 수 있으나 시퀀스.CURRVAL은 WHERE절에서 사용할 수 없음
SELECT TO_CHAR(SYSDATE, 'RRMMDD')||TRIM(TO_CHAR(ORDERS_SEQ.CURRVAL, '000')) ONO FROM DUAL; 

SELECT * FROM ORDERS WHERE ONO=230102003;

SELECT O.PCODE, PNAME, PRICE, QTY, COST
    FROM ORDER_DETAIL O, PRODUCT P
    WHERE O.PCODE=P.PCODE AND
        ONO=230102003;
        
SELECT * FROM ORDERS;
SELECT * FROM ORDER_DETAIL;
SELECT * FROM PRODUCT;